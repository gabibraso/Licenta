/*
* max7219_driver.c
*
* Created: 06-Sep-18 07:43:27 PM
*  Author: gabib
*/

#include "max7219_driver.h"
#include "spi_driver.h"
#include <avr/io.h>
#define F_CPU 7372800UL

void initMatrix(uint8_t dMode, uint8_t brightness, uint8_t limit, uint8_t power, uint8_t test)
{
	decodeMode(dMode);
	displayBrightness(brightness);
	scanLimit(limit);
	powerMatrix(power);
	displayTest(test);
	smile();
}

void decodeMode(uint8_t dMode)
{
	uint8_t i = 0;
	uint8_t command = 0x09;
	
	*(spiStruct.spiPort) &= ~(1<<spiStruct.SSPin);
	for(i=0;i<NUMBER_OF_DEVICES;i++)
	{	//1 byte address(command) and 1 byte data
		spiTransmitByPolling(command);
		spiTransmitByPolling(dMode);
	}
	*(spiStruct.spiPort) |= (1<<spiStruct.SSPin);
}


void displayBrightness(uint8_t brightness)
{
	uint8_t i = 0;
	uint8_t command = 0x0A;
	
	*(spiStruct.spiPort) &= ~(1<<spiStruct.SSPin);
	for(i=0;i<NUMBER_OF_DEVICES;i++)
	{	//1 byte address(command) and 1 byte data
		spiTransmitByPolling(command);
		spiTransmitByPolling(brightness);
	}
	*(spiStruct.spiPort) |= (1<<spiStruct.SSPin);
}

void  scanLimit(uint8_t limit)
{
	uint8_t i = 0;
	uint8_t command = 0x0B;
	
	*(spiStruct.spiPort) &= ~(1<<spiStruct.SSPin);
	for(i=0;i<NUMBER_OF_DEVICES;i++)
	{	//1 byte address(command) and 1 byte data
		spiTransmitByPolling(command);
		spiTransmitByPolling(limit);
	}
	*(spiStruct.spiPort) |= (1<<spiStruct.SSPin);
	
}

void powerMatrix(uint8_t power)
{
	uint8_t i = 0;
	uint8_t command = 0x0C;
	
	*(spiStruct.spiPort) &= ~(1<<spiStruct.SSPin);
	for(i=0;i<NUMBER_OF_DEVICES;i++)
	{	//1 byte address(command) and 1 byte data
		spiTransmitByPolling(command);
		spiTransmitByPolling(power);
	}
	*(spiStruct.spiPort) |= (1<<spiStruct.SSPin);
}

void displayTest(uint8_t test)
{
	uint8_t i = 0;
	uint8_t command = 0x0F;
	
	*(spiStruct.spiPort) &= ~(1<<spiStruct.SSPin);
	for(i=0;i<NUMBER_OF_DEVICES;i++)
	{	//1 byte address(command) and 1 byte data
		spiTransmitByPolling(command);
		spiTransmitByPolling(test);
	}
	*(spiStruct.spiPort) |= (1<<spiStruct.SSPin);
}

void clearMatrix(void)
{
	for(uint8_t x = 1; x < 9; x++) // for all columns
	{
		*(spiStruct.spiPort) &= ~(1<<spiStruct.SSPin);
		for(uint8_t i = 0; i < NUMBER_OF_DEVICES; i++)
		{
			spiTransmitByPolling(x);    // Select column x
			spiTransmitByPolling(0x00); // Set column to 0
		}
		*(spiStruct.spiPort) |= (1<<spiStruct.SSPin);
	}
}

void writeWord(uint8_t address, uint8_t data)
{
	spiTransmitByPolling(address);
	spiTransmitByPolling(data);
}

void sendDigit(uint8_t digit, uint8_t value)
{
	uint8_t i = 0;
	
	*(spiStruct.spiPort) &= ~(1<<spiStruct.SSPin);
	for(i=0;i<NUMBER_OF_DEVICES;i++)
	{	//1 byte address(command) and 1 byte data
		spiTransmitByPolling(digit);
		spiTransmitByPolling(value);
	}
	*(spiStruct.spiPort) |= (1<<spiStruct.SSPin);
}

void arrowUp()
{
	for(uint8_t i = 0; i<1; i++)
	{
	sendDigit(0x08,0x00);
	sendDigit(0x07,0x00);
	sendDigit(0x06,0x00);
	sendDigit(0x05,0x00);
	sendDigit(0x04,0x00);
	sendDigit(0x03,0x00);
	sendDigit(0x02,0x00);
	sendDigit(0x01,0x00);
	_delay_ms(500);
	
	sendDigit(0x08,0x18);
	sendDigit(0x07,0x00);
	sendDigit(0x06,0x00);
	sendDigit(0x05,0x00);
	sendDigit(0x04,0x00);
	sendDigit(0x03,0x00);
	sendDigit(0x02,0x00);
	sendDigit(0x01,0x00);
	_delay_ms(500);
	
	sendDigit(0x08,0x3c);
	sendDigit(0x07,0x18);
	sendDigit(0x06,0x00);
	sendDigit(0x05,0x00);
	sendDigit(0x04,0x00);
	sendDigit(0x03,0x00);
	sendDigit(0x02,0x00);
	sendDigit(0x01,0x00);
	_delay_ms(500);
	
	sendDigit(0x08,0x7e);
	sendDigit(0x07,0x3c);
	sendDigit(0x06,0x18);
	sendDigit(0x05,0x00);
	sendDigit(0x04,0x00);
	sendDigit(0x03,0x00);
	sendDigit(0x02,0x00);
	sendDigit(0x01,0x00);
	_delay_ms(500);
	
	sendDigit(0x08,0xff);
	sendDigit(0x07,0x7e);
	sendDigit(0x06,0x3c);
	sendDigit(0x05,0x18);
	sendDigit(0x04,0x00);
	sendDigit(0x03,0x00);
	sendDigit(0x02,0x00);
	sendDigit(0x01,0x00);
	_delay_ms(500);
	
	sendDigit(0x08,0x3c);
	sendDigit(0x07,0xff);
	sendDigit(0x06,0x7e);
	sendDigit(0x05,0x3c);
	sendDigit(0x04,0x18);
	sendDigit(0x03,0x00);
	sendDigit(0x02,0x00);
	sendDigit(0x01,0x00);
	_delay_ms(500);
	
	sendDigit(0x08,0x3c);
	sendDigit(0x07,0x3c);
	sendDigit(0x06,0xff);
	sendDigit(0x05,0x7e);
	sendDigit(0x04,0x3c);
	sendDigit(0x03,0x18);
	sendDigit(0x02,0x00);
	sendDigit(0x01,0x00);
	_delay_ms(500);
	
	sendDigit(0x08,0x3c);
	sendDigit(0x07,0x3c);
	sendDigit(0x06,0x3c);
	sendDigit(0x05,0xff);
	sendDigit(0x04,0x7e);
	sendDigit(0x03,0x3c);
	sendDigit(0x02,0x18);
	sendDigit(0x01,0x00);
	_delay_ms(500);
	
	sendDigit(0x08,0x3c);
	sendDigit(0x07,0x3c);
	sendDigit(0x06,0x3c);
	sendDigit(0x05,0x3c);
	sendDigit(0x04,0xff);
	sendDigit(0x03,0x7e);
	sendDigit(0x02,0x3c);
	sendDigit(0x01,0x18);
	_delay_ms(500);
	
	sendDigit(0x08,0x00);
	sendDigit(0x07,0x3c);
	sendDigit(0x06,0x3c);
	sendDigit(0x05,0x3c);
	sendDigit(0x04,0x3c);
	sendDigit(0x03,0xff);
	sendDigit(0x02,0x7e);
	sendDigit(0x01,0x3c);
	_delay_ms(500);
	
	sendDigit(0x08,0x00);
	sendDigit(0x07,0x00);
	sendDigit(0x06,0x3c);
	sendDigit(0x05,0x3c);
	sendDigit(0x04,0x3c);
	sendDigit(0x03,0x3c);
	sendDigit(0x02,0xff);
	sendDigit(0x01,0x7e);
	_delay_ms(500);
	
	sendDigit(0x08,0x00);
	sendDigit(0x07,0x00);
	sendDigit(0x06,0x00);
	sendDigit(0x05,0x3c);
	sendDigit(0x04,0x3c);
	sendDigit(0x03,0x3c);
	sendDigit(0x02,0x3c);
	sendDigit(0x01,0xff);
	_delay_ms(500);
	
	sendDigit(0x08,0x00);
	sendDigit(0x07,0x00);
	sendDigit(0x06,0x00);
	sendDigit(0x05,0x00);
	sendDigit(0x04,0x3c);
	sendDigit(0x03,0x3c);
	sendDigit(0x02,0x3c);
	sendDigit(0x01,0x3c);
	_delay_ms(500);
	
	sendDigit(0x07,0x00);
	sendDigit(0x07,0x00);
	sendDigit(0x06,0x00);
	sendDigit(0x05,0x00);
	sendDigit(0x04,0x00);
	sendDigit(0x03,0x3c);
	sendDigit(0x02,0x3c);
	sendDigit(0x01,0x3c);
	_delay_ms(500);
	
	sendDigit(0x07,0x00);
	sendDigit(0x07,0x00);
	sendDigit(0x06,0x00);
	sendDigit(0x05,0x00);
	sendDigit(0x04,0x00);
	sendDigit(0x03,0x00);
	sendDigit(0x02,0x3c);
	sendDigit(0x01,0x3c);
	_delay_ms(500);
	
	sendDigit(0x08,0x00);
	sendDigit(0x07,0x00);
	sendDigit(0x06,0x00);
	sendDigit(0x05,0x00);
	sendDigit(0x04,0x00);
	sendDigit(0x03,0x00);
	sendDigit(0x02,0x00);
	sendDigit(0x01,0x3c);
	_delay_ms(500);
	
	for(uint8_t i =1;i<9;i++)
	{
		sendDigit(i,0x00);
	}
	_delay_ms(500);
	
	}
}

void arrowDown()
{
	for(uint8_t i = 0; i<1; i++)
	{
		sendDigit(0x08,0x00);
		sendDigit(0x07,0x00);
		sendDigit(0x06,0x00);
		sendDigit(0x05,0x00);
		sendDigit(0x04,0x00);
		sendDigit(0x03,0x00);
		sendDigit(0x02,0x00);
		sendDigit(0x01,0x00);
		_delay_ms(500);
		
		sendDigit(0x08,0x00);
		sendDigit(0x07,0x00);
		sendDigit(0x06,0x00);
		sendDigit(0x05,0x00);
		sendDigit(0x04,0x00);
		sendDigit(0x03,0x00);
		sendDigit(0x02,0x00);
		sendDigit(0x01,0x18);
		_delay_ms(500);
		
		sendDigit(0x08,0x00);
		sendDigit(0x07,0x00);
		sendDigit(0x06,0x00);
		sendDigit(0x05,0x00);
		sendDigit(0x04,0x00);
		sendDigit(0x03,0x00);
		sendDigit(0x02,0x18);
		sendDigit(0x01,0x3c);
		_delay_ms(500);
		
		sendDigit(0x08,0x00);
		sendDigit(0x07,0x00);
		sendDigit(0x06,0x00);
		sendDigit(0x05,0x00);
		sendDigit(0x04,0x00);
		sendDigit(0x03,0x18);
		sendDigit(0x02,0x3c);
		sendDigit(0x01,0x7e);
		_delay_ms(500);
		
		sendDigit(0x08,0x00);
		sendDigit(0x07,0x00);
		sendDigit(0x06,0x00);
		sendDigit(0x05,0x00);
		sendDigit(0x04,0x18);
		sendDigit(0x03,0x3c);
		sendDigit(0x02,0x7e);
		sendDigit(0x01,0xff);
		_delay_ms(500);
		
		sendDigit(0x08,0x00);
		sendDigit(0x07,0x00);
		sendDigit(0x06,0x00);
		sendDigit(0x05,0x18);
		sendDigit(0x04,0x3c);
		sendDigit(0x03,0x7e);
		sendDigit(0x02,0xff);
		sendDigit(0x01,0x3c);
		_delay_ms(500);
		
		sendDigit(0x08,0x00);
		sendDigit(0x07,0x00);
		sendDigit(0x06,0x18);
		sendDigit(0x05,0x3c);
		sendDigit(0x04,0x7e);
		sendDigit(0x03,0xff);
		sendDigit(0x02,0x3c);
		sendDigit(0x01,0x3c);
		_delay_ms(500);
		
		sendDigit(0x08,0x00);
		sendDigit(0x07,0x18);
		sendDigit(0x06,0x3c);
		sendDigit(0x05,0x7e);
		sendDigit(0x04,0xff);
		sendDigit(0x03,0x3c);
		sendDigit(0x02,0x3c);
		sendDigit(0x01,0x3c);
		_delay_ms(500);
		
		sendDigit(0x08,0x18);
		sendDigit(0x07,0x3c);
		sendDigit(0x06,0x7e);
		sendDigit(0x05,0xff);
		sendDigit(0x04,0x3c);
		sendDigit(0x03,0x3c);
		sendDigit(0x02,0x3c);
		sendDigit(0x01,0x3c);
		_delay_ms(500);
		
		sendDigit(0x08,0x3c);
		sendDigit(0x07,0x7e);
		sendDigit(0x06,0xff);
		sendDigit(0x05,0x3c);
		sendDigit(0x04,0x3c);
		sendDigit(0x03,0x3c);
		sendDigit(0x02,0x3c);
		sendDigit(0x01,0x00);
		_delay_ms(500);
		
		sendDigit(0x08,0x7e);
		sendDigit(0x07,0xff);
		sendDigit(0x06,0x3c);
		sendDigit(0x05,0x3c);
		sendDigit(0x04,0x3c);
		sendDigit(0x03,0x3c);
		sendDigit(0x02,0x00);
		sendDigit(0x01,0x00);
		_delay_ms(500);
		
		sendDigit(0x08,0xff);
		sendDigit(0x07,0x3c);
		sendDigit(0x06,0x3c);
		sendDigit(0x05,0x3c);
		sendDigit(0x04,0x3c);
		sendDigit(0x03,0x00);
		sendDigit(0x02,0x00);
		sendDigit(0x01,0x00);
		_delay_ms(500);
		
		sendDigit(0x08,0x3c);
		sendDigit(0x07,0x3c);
		sendDigit(0x06,0x3c);
		sendDigit(0x05,0x3c);
		sendDigit(0x04,0x00);
		sendDigit(0x03,0x00);
		sendDigit(0x02,0x00);
		sendDigit(0x01,0x00);
		_delay_ms(500);
		
		sendDigit(0x08,0x3c);
		sendDigit(0x07,0x3c);
		sendDigit(0x06,0x3c);
		sendDigit(0x05,0x00);
		sendDigit(0x04,0x00);
		sendDigit(0x03,0x00);
		sendDigit(0x02,0x00);
		sendDigit(0x01,0x00);
		_delay_ms(500);
		
		sendDigit(0x08,0x3c);
		sendDigit(0x07,0x3c);
		sendDigit(0x06,0x00);
		sendDigit(0x05,0x00);
		sendDigit(0x04,0x00);
		sendDigit(0x03,0x00);
		sendDigit(0x02,0x00);
		sendDigit(0x01,0x00);
		_delay_ms(500);
		
		sendDigit(0x08,0x3c);
		sendDigit(0x07,0x00);
		sendDigit(0x06,0x00);
		sendDigit(0x05,0x00);
		sendDigit(0x04,0x00);
		sendDigit(0x03,0x00);
		sendDigit(0x02,0x00);
		sendDigit(0x01,0x00);
		_delay_ms(500);
		
		for(uint8_t i =1;i<9;i++)
		{
			sendDigit(i,0x00);
		}
		_delay_ms(500);
	}
}

void floorError()
{
		sendDigit(0x08,0xc3);
		sendDigit(0x07,0xc3);
		sendDigit(0x06,0x24);
		sendDigit(0x05,0x18);
		sendDigit(0x04,0x18);
		sendDigit(0x03,0x24);
		sendDigit(0x02,0xc3);
		sendDigit(0x01,0xc3);
		
}

void smile()
{
	sendDigit(0x08,0x3c);
	sendDigit(0x07,0x42);
	sendDigit(0x06,0x99);
	sendDigit(0x05,0xa5);
	sendDigit(0x04,0x81);
	sendDigit(0x03,0xa5);
	sendDigit(0x02,0x42);
	sendDigit(0x01,0x3c);
}

void bell()
{
	sendDigit(0x08,0x18);//18
	sendDigit(0x07,0x3c);//24
	sendDigit(0x06,0xff);//24
	sendDigit(0x05,0x42);//42
	sendDigit(0x04,0x42);//81//42
	sendDigit(0x03,0x24);//ff
	sendDigit(0x02,0x24);//3c
	sendDigit(0x01,0x18);//18
}
